
/**
 * @fileoverview Firestore Security Rules for Darpan Wears Mobile Shop.
 *
 * Core Philosophy:
 * This ruleset implements a role-based access control system where all users can read product information,
 * but only users with a designated admin role can create, update, or delete products.
 * Customer can manage their own profile data, order history, and chats. Admins can manage all orders and chats.
 *
 * Data Structure:
 * - /products/{productId}: Stores publicly readable product information.
 * - /roles_admin/{userId}: Indicates admin privileges.
 * - /users/{userId}: Stores customer profile information.
 * - /users/{userId}/orders/{orderId}: Stores order history for a specific user.
 * - /chats/{userId}/messages/{messageId}: Messages within a chat session.
 *
 * Key Security Decisions:
 * - Public read access to the /products collection to enable product browsing.
 * - Administrative privileges are determined by the presence of a document in the `/roles_admin/{userId}` collection.
 * - Customer can only access their own data in `/users/{userId}` and its subcollections.
 * - Admins have read access to all orders and chats.
 *
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     * @return {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the user is an admin based on the document at /roles_admin/{userId}.
     * @return {boolean} True if the user is an admin, false otherwise.
     */
    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    /**
     * @description Checks if the user is the owner of the document.
     * @param {string} userId - The user ID to check against the request's auth UID.
     * @return {boolean} True if the user ID matches the request's auth UID, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    /**
     * @description Rules for the /products/{productId} collection. Allows read access to all users, but only admins can create, update, or delete products.
     */
    match /products/{productId} {
      allow get, list: if true;
      allow write: if isAdmin();
    }

    /**
     * @description Rules for the /roles_admin/{userId} collection. Only admins can modify roles.
     */
    match /roles_admin/{userId} {
      allow read, write: if isAdmin();
      allow list: if false;
    }
    
    /**
     * @description Rules for the /users/{userId} collection and its subcollections.
     */
    match /users/{userId} {
      // Users can only read and write their own profile document.
      allow read, write: if isOwner(userId);
      allow list: if false; // Prevent listing all users

      /**
       * @description Rules for the orders subcollection. This controls direct access within a user's path.
       */
      match /orders/{orderId} {
        // Allow user to create and read their own orders.
        allow create, get, list: if isOwner(userId);
        
        // User can update their own order to cancel or rate it.
        // Admin can update any order (e.g., to change status).
        // This rule is needed for admins to update status via a direct path.
        allow update: if (isOwner(userId) && (
                          (request.resource.data.status == 'Cancelled' && resource.data.status == 'Processing')
                          || request.resource.data.keys().hasAll(['rating', 'review'])
                          || request.resource.data.keys().hasAll(['rating'])
                        )) || isAdmin();
      }
    }
    
     /**
     * @description Rules for the /chats collection.
     */
    match /chats/{userId}/messages/{messageId} {
      // User can read/list their own messages. Admin can read/list all messages.
      allow read, list: if isOwner(userId) || isAdmin();
      
      // User can create messages in their own chat. Admin can create messages in any chat.
      allow create: if (isOwner(userId) && request.resource.data.senderId == userId)
                    || (isAdmin() && request.resource.data.senderId == 'admin');
    }

    /**
     * @description Collection group rule for 'orders'. This allows admins to query across all users' orders.
     */
    match /{path=**}/orders/{orderId} {
      // Admins can perform list (collection group query) and get operations on any order.
      allow list, get: if isAdmin();
    }

    /**
     * @description Collection group rule for 'messages'. This allows admins to query across all users' messages.
     */
     match /{path=**}/messages/{messageId} {
      allow list: if isAdmin();
     }
  }
}
