/**
 * @file Firestore Security Rules for Darpan Wears Mobile Shop
 * @description This ruleset enforces a strict user-ownership model for user-specific data while allowing public read access to product information.
 *
 * Data Structure:
 * - /users/{userId}: User account information, accessible only by the user.
 * - /products/{productId}: Publicly accessible product details.
 * - /users/{userId}/shoppingCart: User's shopping cart.
 * - /users/{userId}/shoppingCart/cartItems/{cartItemId}: Items within the user's shopping cart.
 * - /users/{userId}/orders/{orderId}: User's order history.
 * - /users/{userId}/orders/{orderId}/orderItems/{orderItemId}: Items within a specific order.
 * - /users/{userId}/recommendations/{recommendationId}: Product recommendations for the user.
 *
 * Key Security Decisions:
 * - Strict user ownership: Most user data is nested under /users/{userId} and accessible only to the authenticated user with a matching ID.
 * - Public product data: Product information in /products/{productId} is publicly readable.
 * - No user listing: Listing all users is disallowed for privacy.
 * - Denormalization: Not explicitly used due to the path-based ownership model.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Secure user account information.
     * @path /users/{userId}
     * @allow (create) User with ID 'user123' creates their own account.
     *    - request.auth.uid: 'user123'
     *    - request.resource.data.id: 'user123'
     * @allow (get) User with ID 'user123' reads their own account information.
     *    - request.auth.uid: 'user123'
     * @deny (update) User with ID 'user456' attempts to update user 'user123' account.
     *    - request.auth.uid: 'user456'
     * @principle Enforces document ownership for writes and reads.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.id == userId;
      allow update: if isSignedIn() && isOwner(userId) && resource.data.id == request.resource.data.id;
      allow delete: if isSignedIn() && isOwner(userId) && resource != null;
    }

    /**
     * @description Allows public read access to product information.
     * @path /products/{productId}
     * @allow (get) Any user can read product 'product123' information.
     *    - request.auth.uid: null (or any user ID)
     * @allow (list) Any user can list all products.
     *    - request.auth.uid: null (or any user ID)
     * @deny (create) Any user attempts to create a new product.
     *    - request.auth.uid: 'user123'
     * @principle Allows public read access to product information.
     */
    match /products/{productId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Secures the user's shopping cart.
     * @path /users/{userId}/shoppingCart
     * @allow (get) User with ID 'user123' reads their shopping cart.
     *    - request.auth.uid: 'user123'
     * @allow (create) User with ID 'user123' creates their shopping cart.
     *    - request.auth.uid: 'user123'
     *    - request.resource.data.userAccountId: 'user123'
     * @deny (update) User with ID 'user456' attempts to update user 'user123' shopping cart.
     *    - request.auth.uid: 'user456'
     * @principle Enforces document ownership for writes and reads.
     */
    match /users/{userId}/shoppingCart {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.userAccountId == userId;
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId) && resource != null;
    }

    /**
     * @description Secures the cart items within a user's shopping cart.
     * @path /users/{userId}/shoppingCart/cartItems/{cartItemId}
     * @allow (get) User with ID 'user123' reads a cart item in their cart.
     *    - request.auth.uid: 'user123'
     * @allow (create) User with ID 'user123' adds an item to their cart.
     *    - request.auth.uid: 'user123'
     * @deny (update) User with ID 'user456' attempts to update a cart item in user 'user123' cart.
     *    - request.auth.uid: 'user456'
     * @principle Enforces document ownership for writes and reads through path.
     */
    match /users/{userId}/shoppingCart/cartItems/{cartItemId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId) && resource != null;
      allow delete: if isSignedIn() && isOwner(userId) && resource != null;
    }

    /**
     * @description Secures the user's order history.
     * @path /users/{userId}/orders/{orderId}
     * @allow (get) User with ID 'user123' reads their order 'order456'.
     *    - request.auth.uid: 'user123'
     * @allow (create) User with ID 'user123' creates a new order.
     *    - request.auth.uid: 'user123'
     *    - request.resource.data.userAccountId: 'user123'
     * @deny (update) User with ID 'user456' attempts to update user 'user123' order.
     *    - request.auth.uid: 'user456'
     * @principle Enforces document ownership for writes and reads through path.
     */
    match /users/{userId}/orders/{orderId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.userAccountId == userId;
      allow update: if isSignedIn() && isOwner(userId) && resource != null;
      allow delete: if isSignedIn() && isOwner(userId) && resource != null;
    }

    /**
     * @description Secures the order items within a user's order.
     * @path /users/{userId}/orders/{orderId}/orderItems/{orderItemId}
     * @allow (get) User with ID 'user123' reads an order item in their order.
     *    - request.auth.uid: 'user123'
     * @allow (create) User with ID 'user123' adds an item to their order.
     *    - request.auth.uid: 'user123'
     * @deny (update) User with ID 'user456' attempts to update an order item in user 'user123' order.
     *    - request.auth.uid: 'user456'
     * @principle Enforces document ownership for writes and reads through path.
     */
    match /users/{userId}/orders/{orderId}/orderItems/{orderItemId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId) && resource != null;
      allow delete: if isSignedIn() && isOwner(userId) && resource != null;
    }

    /**
     * @description Secures product recommendations for a user.
     * @path /users/{userId}/recommendations/{recommendationId}
     * @allow (get) User with ID 'user123' reads their recommendation 'recommendation456'.
     *    - request.auth.uid: 'user123'
     * @allow (create) User with ID 'user123' receives a new recommendation.
     *    - request.auth.uid: 'user123'
     *    - request.resource.data.userAccountId: 'user123'
     * @deny (update) User with ID 'user456' attempts to update user 'user123' recommendation.
     *    - request.auth.uid: 'user456'
     * @principle Enforces document ownership for writes and reads through path.
     */
    match /users/{userId}/recommendations/{recommendationId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.userAccountId == userId;
      allow update: if isSignedIn() && isOwner(userId) && resource != null;
      allow delete: if isSignedIn() && isOwner(userId) && resource != null;
    }
  }
}