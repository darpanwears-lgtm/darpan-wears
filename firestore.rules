/**
 * @fileoverview Firestore Security Rules for Darpan Wears Mobile Shop.
 *
 * Core Philosophy:
 * This ruleset implements a role-based access control system where all users can read product information,
 * but only users with a designated admin role can create, update, or delete products.
 *
 * Data Structure:
 * - /products/{productId}: Stores publicly readable product information.
 * - /roles_admin/{userId}: Indicates admin privileges.
 *
 * Key Security Decisions:
 * - Public read access to the /products collection to enable product browsing.
 * - Administrative privileges are determined by the presence of a document in the `/roles_admin/{userId}` collection,
 *   which contains the user's UID.
 * - No user listing is allowed for admin roles.
 *
 * Denormalization for Authorization:
 * The presence of a user ID in the `roles_admin` collection is used to determine if a user has admin privileges.
 * This avoids needing to store additional role information within the user document or product data.
 *
 * Structural Segregation:
 * Admin roles are stored in a separate collection (`/roles_admin`) to isolate administrative privileges from product data,
 * preventing unintended access or modification of product information by non-admin users.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     * @return {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the user is an admin based on the document at /roles_admin/{userId}.
     * @return {boolean} True if the user is an admin, false otherwise.
     */
    function isAdmin() {
      return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    /**
     * @description Checks if the user is the owner of the document (used for /roles_admin/{userId}).
     * @param {string} userId - The user ID to check against the request's auth UID.
     * @return {boolean} True if the user ID matches the request's auth UID, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

     /**
      * @description Checks if the user is the existing owner of the document.
      *              This combines the ownership check with an existence check to prevent
      *              updates or deletes on non-existent documents.
      * @param {string} userId - The user ID to compare with the document's owner ID.
      * @return {boolean} True if the user is the owner and the document exists, false otherwise.
      */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }
   /**
     * @description Rules for the /products/{productId} collection. Allows read access to all users, but only admins can create, update, or delete products.
     * @path /products/{productId}
     * @allow (get, list) - Any user can read product information.
     *    Example: A user browsing the product catalog.
     * @allow (create, update, delete) - Only an admin user can modify product information.
     *    Example: An admin adding a new product to the store.
     * @deny (create, update, delete) - A non-admin user attempting to create, update, or delete product information.
     *    Example: A regular user attempting to change the price of a product.
     * @principle Allows public read access while restricting write access to admins.
     */
    match /products/{productId} {
      allow get, list: if true;
      allow create: if isSignedIn() && isAdmin();
      allow update: if isSignedIn() && isAdmin() && resource != null;
      allow delete: if isSignedIn() && isAdmin() && resource != null;
    }

    /**
     * @description Rules for the /roles_admin/{userId} collection. Allows creating the document only if the user ID matches the authenticated user ID. Updates and deletes are only allowed by the owner, and listing is denied to protect user privacy.
     * @path /roles_admin/{userId}
     * @allow (create) - A user can create their admin role document if the user ID matches their auth UID.
     *    Example: A user being granted admin privileges.
     * @allow (update, delete) - Only the owner (the user with the matching UID) can update or delete the admin role document, and only if the document already exists.
     *    Example: An admin revoking their own admin privileges.
     * @deny (create) - A user attempting to create an admin role document for another user.
     *    Example: A regular user trying to grant themselves admin rights by creating a document with a different user ID.
     * @deny (list) - Prevents listing of all admin roles to protect user privacy.
     * @principle Enforces self-creation of admin roles and restricts access to only the owner of the role.
     */
    match /roles_admin/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }
  }
}